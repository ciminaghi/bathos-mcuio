#!/bin/bash
#set -x

find_evts() {
    local e
    exec 3< $1
    while read -u 3 line ; do
	echo $line | grep -q '^[ ]*declare_event(' || continue
	e=$(echo $line | sed -e 's/declare_event(\([^,]*.*\));/\1/g')
	# do not take the same event twice
	echo $evts | grep -w -q $e && continue
	echo $e
    done
}


[ $# -lt 2 ] && { echo "Use $0 <out_path> <dir_path1> [<dir_path2> ... <dir_pathn> ]" ; \
    exit 1 ; }

output_file=$1
shift
dirs=$*

echo "$0 started"

for d in $dirs ; do
    echo $0: scanning dir $d
    for f in $(find $d -maxdepth 1 -type f -name \*.c) ; do
	e=$(find_evts $f)
	evts="$evts $e"
    done
done

echo "$0: generating output file $output_file"

>$output_file cat <<EOF
/* $output_file: generated by $0 (cmdline $0 $*) */
EOF

for e in $evts; do
    echo "evt_${e}_handlers_start = .;" >> $output_file
    echo "*(.evt_${e}_handlers);" >> $output_file
    echo "evt_${e}_handlers_end = .;" >> $output_file
done

